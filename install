function Write-ColorMessage {
    param (
        [string]$message,
        [ConsoleColor]$color = [ConsoleColor]::Green
    )
    $currentColor = $Host.UI.RawUI.ForegroundColor
    $Host.UI.RawUI.ForegroundColor = $color
    Write-Host $message
    $Host.UI.RawUI.ForegroundColor = $currentColor
}

function Stop-And-RemoveService {
    param (
        [string]$serviceName,
        [string]$processName = $null
    )

    if ($processName -and (Get-Process -Name $processName -ErrorAction SilentlyContinue)) {
        Write-ColorMessage "Остановка процесса $processName..." -color Green
        try {
            Stop-Process -Name $processName -Force -ErrorAction SilentlyContinue
        } catch {
            # Ошибка подавлена
        }
    }

    if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
        Write-ColorMessage "Остановка службы $serviceName..." -color Green
        try {
            Stop-Service -Name $serviceName -Force -ErrorAction SilentlyContinue
        } catch {
            # Ошибка подавлена
        }

        Write-ColorMessage "Удаление службы $serviceName..." -color Green
        try {
            & sc.exe delete $serviceName -ErrorAction SilentlyContinue
        } catch {
            # Ошибка подавлена
        }
    }
}

# Проверка прав администратора
If (-Not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator))
{
    Write-ColorMessage "Пожалуйста, запустите этот скрипт от имени администратора." -color Green
    exit
}

$servicesToStop = @("ZapretService", "windivert", "zapret")
$processesToStop = @("winws")

foreach ($service in $servicesToStop) {
    Stop-And-RemoveService -serviceName $service
}

foreach ($process in $processesToStop) {
    if (Get-Process -Name $process -ErrorAction SilentlyContinue) {
        Write-ColorMessage "Остановка процесса $process..." -color Green
        try {
            Stop-Process -Name $process -Force -ErrorAction SilentlyContinue
        } catch {
            # Ошибка подавлена
        }
    }
}

$desktopPath = [System.Environment]::GetFolderPath('Desktop')
$zapretZipPath = "$env:USERPROFILE\Downloads\zapret.zip"
$defaultDestinationPath = $desktopPath
$zipUrl = "https://github.com/vayulqq/zapret/releases/download/qedqedndndn/zapret.zip"

# Запросить у пользователя путь для распаковки
$destinationPath = Read-Host "Введите путь для распаковки или нажмите Enter для распаковки на рабочий стол"

if (-not $destinationPath) {
    $destinationPath = $defaultDestinationPath
}

if (Test-Path $zapretZipPath) {
    Write-ColorMessage "Удаление старого ZIP архива..." -color Green
    Remove-Item $zapretZipPath -Force -ErrorAction SilentlyContinue
}

if ($destinationPath -eq $desktopPath -and (Test-Path $desktopPath\zapret)) {
    $deleteFolder = Read-Host "Папка zapret уже существует на рабочем столе. Удалить её? (Y/N)"
    if ($deleteFolder -eq 'Y') {
        Write-ColorMessage "Удаление старой папки zapret с рабочего стола..." -color Green
        Remove-Item $desktopPath\zapret -Recurse -Force -ErrorAction SilentlyContinue
    } else {
        Write-ColorMessage "Операция отменена пользователем." -color Green
        exit
    }
}

Write-ColorMessage "Скачивание ZIP файла..." -color Green
try {
    Invoke-WebRequest -Uri $zipUrl -OutFile $zapretZipPath -ErrorAction SilentlyContinue
    Write-ColorMessage "ZIP файл успешно скачан!" -color Green
} catch {
    # Ошибка подавлена
    exit 1
}

Write-ColorMessage "Распаковка архива..." -color Green
try {
    Expand-Archive -Path $zapretZipPath -DestinationPath $destinationPath -Force -ErrorAction SilentlyContinue
    Write-ColorMessage "Архив успешно распакован!" -color Green
} catch {
    # Ошибка подавлена
    exit 1
}

Write-ColorMessage "Удаление ZIP файла..." -color Green
Remove-Item $zapretZipPath -Force -ErrorAction SilentlyContinue

Write-ColorMessage "Открытие README..." -color Green
start https://raw.githubusercontent.com/vayulqq/zapret/main/readme.txt

Write-ColorMessage "Завершение скрипта..." -color Green
pause
