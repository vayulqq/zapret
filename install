# Функция для проверки наличия процесса
function Check-Process($processName) {
    $process = Get-Process | Where-Object { $_.Name -eq $processName }
    return $process
}

# Функция для остановки и удаления службы
function Remove-Service($serviceName) {
    $service = Get-Service -Name $serviceName -ErrorAction SilentlyContinue
    if ($service) {
        Stop-Service -Name $serviceName -Force
        Set-Service -Name $serviceName -StartupType Disabled
        sc.exe delete $serviceName
    }
}

# Проверка и остановка процесса winws.exe
$winwsProcess = Check-Process "winws"
if ($winwsProcess) {
    Stop-Process -Name "winws" -Force
}

# Проверка и удаление служб windivert, ZapretService и zapret
$servicesToRemove = @("windivert", "ZapretService", "zapret")
foreach ($service in $servicesToRemove) {
    Remove-Service $service
}

# Скачивание архива zapret_vayul.zip
$downloadUrl = "https://github.com/vayulqq/zapret/releases/download/zapret/zapret_vayul.zip"
$downloadPath = [System.IO.Path]::Combine([Environment]::GetFolderPath("MyDocuments"), "Downloads", "zapret_vayul.zip")

Invoke-WebRequest -Uri $downloadUrl -OutFile $downloadPath

# Запрос у пользователя пути для распаковки
$defaultExtractPath = [System.IO.Path]::Combine([Environment]::GetFolderPath("Desktop"))
$extractPath = Read-Host "Введите путь для распаковки (по умолчанию на рабочий стол):"
if (-not $extractPath) {
    $extractPath = $defaultExtractPath
}

# Проверка и удаление папки zapret_vayul, если она существует
$zapretFolderPath = [System.IO.Path]::Combine($extractPath, "zapret_vayul")
if (Test-Path -Path $zapretFolderPath) {
    Write-Host "Папка 'zapret_vayul' уже существует. Удаляю её..."
    Remove-Item -Path $zapretFolderPath -Recurse -Force
}

# Распаковка архива
Expand-Archive -Path $downloadPath -DestinationPath $extractPath

# Удаление архива после распаковки
Remove-Item -Path $downloadPath

# Открытие сайта
Start-Process "https://raw.githubusercontent.com/vayulqq/zapret/main/readme.txt"

# Пауза
Pause
