# Функция для вывода цветных сообщений
function Write-ColorMessage {
    param (
        [string]$message,
        [string]$color = "White"
    )
    Write-Host $message -ForegroundColor $color
}

# Функция для остановки процессов/служб и их удаления
function Stop-And-RemoveService {
    param (
        [string]$serviceName,
        [string]$processName = $null
    )

    # Останавливаем процесс, если он существует
    if ($processName) {
        if (Get-Process -Name $processName -ErrorAction SilentlyContinue) {
            Write-ColorMessage "Остановка процесса $processName..." -ForegroundColor Red
            try {
                Stop-Process -Name $processName -Force -ErrorAction SilentlyContinue 2>$null
            } catch {
                Write-ColorMessage "Ошибка при остановке процесса $processName!" -ForegroundColor Yellow
            }
        }
    }

    # Останавливаем и удаляем службу, если она существует
    if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
        Write-ColorMessage "Остановка службы $serviceName..." -ForegroundColor Red
        try {
            Stop-Service -Name $serviceName -Force -ErrorAction SilentlyContinue 2>$null
        } catch {
            Write-ColorMessage "Ошибка при остановке службы $serviceName!" -ForegroundColor Yellow
        }

        Write-ColorMessage "Удаление службы $serviceName..." -ForegroundColor Red
        try {
            & sc.exe delete $serviceName 2>$null
        } catch {
            Write-ColorMessage "Ошибка при удалении службы $serviceName!" -ForegroundColor Yellow
        }
    }
}

# Определение путей
$desktopPath = [System.Environment]::GetFolderPath('Desktop')
$zapretZipPath = "$env:USERPROFILE\Downloads\zapret.zip"
$zapretFolderPath = "$desktopPath\zapret"
$zipUrl = "https://github.com/vayulqq/zapret/releases/download/qedqedndndn/zapret.zip"

# Остановка и удаление процессов и служб
Stop-And-RemoveService -serviceName "ZapretService" -processName "winws"
Stop-And-RemoveService -serviceName "windivert"

# Проверка и удаление предыдущего архива (если существует)
if (Test-Path $zapretZipPath) {
    Write-ColorMessage "Удаление старого ZIP архива..." -ForegroundColor Red
    Remove-Item $zapretZipPath -Force
}

# Проверка и удаление предыдущей папки (если существует)
if (Test-Path $zapretFolderPath) {
    Write-ColorMessage "Удаление старой папки..." -ForegroundColor Red
    Remove-Item $zapretFolderPath -Recurse -Force
}

# Скачивание ZIP файла
Write-ColorMessage "Скачивание ZIP файла..." -ForegroundColor Cyan
try {
    Invoke-WebRequest -Uri $zipUrl -OutFile $zapretZipPath
    Write-ColorMessage "ZIP файл успешно скачан!" -ForegroundColor Green
} catch {
    Write-ColorMessage "Ошибка при скачивании файла!" -ForegroundColor Yellow
    exit 1
}

# Распаковка архива
Write-ColorMessage "Распаковка архива..." -ForegroundColor Cyan
try {
    Expand-Archive -Path $zapretZipPath -DestinationPath $desktopPath -Force
    Write-ColorMessage "Архив успешно распакован!" -ForegroundColor Green
} catch {
    Write-ColorMessage "Ошибка при распаковке архива!" -ForegroundColor Yellow
    exit 1
}

# Удаление ZIP файла после распаковки
Write-ColorMessage "Удаление ZIP файла..." -ForegroundColor Red
Remove-Item $zapretZipPath -Force

# Открытие README
Write-ColorMessage "Открытие README..." -ForegroundColor Cyan
start https://raw.githubusercontent.com/vayulqq/zapret/main/readme.txt

# Завершение текущего процесса
Write-ColorMessage "Завершение скрипта..." -ForegroundColor Magenta
Stop-Process -Id $PID -Force
