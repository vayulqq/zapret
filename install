# Функция для удаления файла, если он существует
Function Remove-File {
    param (
        [string]$filePath
    )
    if (Test-Path $filePath) {
        try {
            Remove-Item -Path $filePath -Force -ErrorAction Stop
        } catch {
            Start-Sleep -Seconds 2
            try {
                Remove-Item -Path $filePath -Force -ErrorAction Stop
            } catch {
                exit 1
            }
        }
    }
}

# Функция для создания off.cmd
Function Create-CleanupScript {
    param (
        [string]$cmdPath,
        [string]$deleteFilePath
    )

    $cmdContent = @"
@echo off
timeout /t 2 >nul
if exist "$deleteFilePath" (
    del /f /q "$deleteFilePath" >nul 2>&1
)
taskkill /f /im "powershell.exe" >nul 2>&1
del /f /q "%~f0" >nul 2>&1
exit
"@
    Set-Content -Path $cmdPath -Value $cmdContent -Encoding ASCII
}

# Основной процесс
try {
    # Настройка путей
    $url = "https://github.com/vayulqq/zapret/releases/download/qedqedndndn/zapret.zip"
    $userProfilePath = [System.Environment]::GetFolderPath("UserProfile")
    $downloadsPath = Join-Path -Path $userProfilePath -ChildPath "Downloads"
    $desktopPath = Join-Path -Path $userProfilePath -ChildPath "Desktop"
    $zipPath = Join-Path -Path $downloadsPath -ChildPath "zapret.zip"
    $zapretFolderPath = Join-Path -Path $desktopPath -ChildPath "zapret"
    $offCmdPath = Join-Path -Path $downloadsPath -ChildPath "off.cmd"

    # Удаление старой папки и файла
    if (Test-Path $zapretFolderPath) { Remove-Item -Path $zapretFolderPath -Recurse -Force }
    Remove-File -filePath $zipPath

    # Скачивание zip файла
    Invoke-WebRequest -Uri $url -OutFile $zipPath -ErrorAction Stop

    # Распаковка zip-файла
    Add-Type -AssemblyName System.IO.Compression.FileSystem
    [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $desktopPath)

    # Создание CMD для очистки
    Create-CleanupScript -cmdPath $offCmdPath -deleteFilePath $zipPath

    # Запуск off.cmd
    Start-Process -FilePath $offCmdPath
    Stop-Process -Id $PID
} catch {
    exit 1
}
