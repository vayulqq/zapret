# Функция для удаления файла
Function Remove-ZipFile {
    param (
        [string]$filePath
    )

    if (Test-Path -Path $filePath) {
        try {
            $fileInUse = $false
            try {
                $file = Get-Item -Path $filePath
                $file.OpenRead() | Out-Null
            } catch {
                $fileInUse = $true
            }

            if (-not $fileInUse) {
                Remove-Item -Path $filePath -Force
            } else {
                Start-Sleep -Seconds 1
                Remove-ZipFile -filePath $filePath  # Повторная попытка
            }
        } catch {
            exit 1
        }
    }
}

# Функция для скачивания файла
Function Download-File {
    param (
        [string]$url,
        [string]$savePath,
        [int]$maxRetries = 3
    )

    $retryCount = 0
    $downloadSuccess = $false
    while ($retryCount -lt $maxRetries -and !$downloadSuccess) {
        try {
            Invoke-WebRequest -Uri $url -OutFile $savePath -ErrorAction Stop
            $downloadSuccess = $true
        } catch {
            $retryCount++
            if ($retryCount -ge $maxRetries) {
                exit 1
            }
            Start-Sleep -Seconds 2  # Задержка перед повторной попыткой
        }
    }
}

# Функция для распаковки ZIP-файла
Function Unpack-Zip {
    param (
        [string]$filePath,
        [string]$extractTo
    )
    
    try {
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($filePath, $extractTo)
    } catch {
        exit 1
    }
}

# Функция для проверки существования папки
Function Ensure-Folder {
    param (
        [string]$folderPath
    )
    
    if (-not (Test-Path $folderPath)) {
        New-Item -ItemType Directory -Path $folderPath | Out-Null
    }
}

# Основной процесс
try {
    $url = "https://github.com/vayulqq/zapret/releases/download/qedqedndndn/zapret.zip"
    $userProfilePath = [System.Environment]::GetFolderPath("UserProfile")
    $downloadsPath = Join-Path -Path $userProfilePath -ChildPath "Downloads"
    $desktopPath = Join-Path -Path $userProfilePath -ChildPath "Desktop"

    # Локальный путь для сохранения ZIP-файла в папке Загрузки
    $zipPath = Join-Path -Path $downloadsPath -ChildPath "zapret.zip"

    # Убедимся, что папки существуют
    Ensure-Folder -folderPath $downloadsPath
    Ensure-Folder -folderPath $desktopPath

    # Скачиваем файл
    Download-File -url $url -savePath $zipPath

    # Распаковка ZIP-файла на рабочий стол
    Unpack-Zip -filePath $zipPath -extractTo $desktopPath

    # Удаление исходного ZIP-файла после успешной распаковки
    Remove-ZipFile -filePath $zipPath

} catch {
    exit 1
}
