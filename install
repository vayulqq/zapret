# Проверка прав администратора
If (-Not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-ColorMessage "Пожалуйста, запустите этот скрипт от имени администратора." -color Red
    exit
}

function Write-ColorMessage {
    param (
        [string]$message,
        [ConsoleColor]$color = [ConsoleColor]::Green
    )
    $currentColor = $Host.UI.RawUI.ForegroundColor
    $Host.UI.RawUI.ForegroundColor = $color
    Write-Host $message
    $Host.UI.RawUI.ForegroundColor = $currentColor
}

function Stop-And-RemoveService {
    param (
        [string]$serviceName,
        [string]$processName = $null
    )

    # Остановка связанного процесса, если он есть
    if ($processName -and (Get-Process -Name $processName -ErrorAction SilentlyContinue)) {
        Write-ColorMessage "Остановка процесса $processName..." -color Yellow
        try {
            Stop-Process -Name $processName -Force -ErrorAction SilentlyContinue
        } catch {
            Write-ColorMessage "Ошибка при остановке процесса $processName!" -color Red
        }
    }

    # Остановка службы
    if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
        Write-ColorMessage "Остановка службы $serviceName..." -color Yellow
        try {
            Stop-Service -Name $serviceName -Force -ErrorAction SilentlyContinue
            Write-ColorMessage "Служба $serviceName остановлена!" -color Green
        } catch {
            Write-ColorMessage "Ошибка при остановке службы $serviceName!" -color Red
        }

        # Удаление службы
        Write-ColorMessage "Удаление службы $serviceName..." -color Yellow
        try {
            & sc.exe delete $serviceName
            Write-ColorMessage "Служба $serviceName удалена!" -color Green
        } catch {
            Write-ColorMessage "Ошибка при удалении службы $serviceName!" -color Red
        }
    } else {
        Write-ColorMessage "Служба $serviceName не найдена!" -color Red
    }
}

$servicesToStop = @("ZapretService", "windivert", "zapret")
$processesToStop = @("winws")

# Остановка служб и процессов
foreach ($service in $servicesToStop) {
    Stop-And-RemoveService -serviceName $service
}

foreach ($process in $processesToStop) {
    if (Get-Process -Name $process -ErrorAction SilentlyContinue) {
        Write-ColorMessage "Остановка процесса $process..." -color Yellow
        try {
            Stop-Process -Name $process -Force -ErrorAction SilentlyContinue
        } catch {
            Write-ColorMessage "Ошибка при остановке процесса $process!" -color Red
        }
    } else {
        Write-ColorMessage "Процесс $process не найден!" -color Red
    }
}

$desktopPath = [System.Environment]::GetFolderPath('Desktop')
$zapretZipPath = "$env:USERPROFILE\Downloads\zapret.zip"
$defaultDestinationPath = "$desktopPath\zapret"
$zipUrl = "https://github.com/vayulqq/zapret/releases/download/qedqedndndn/zapret.zip"

# Запросить у пользователя путь для распаковки
$destinationPath = Read-Host "Введите путь для распаковки или нажмите Enter для распаковки на рабочий стол"

if (-not $destinationPath) {
    $destinationPath = $defaultDestinationPath
}

if (Test-Path $zapretZipPath) {
    Write-ColorMessage "Удаление старого ZIP архива..." -color Magenta
    Remove-Item $zapretZipPath -Force
}

# Проверка и удаление существующих папок zapret и zapret_vayul на рабочем столе
if ($destinationPath -eq "$desktopPath\zapret") {
    if (Test-Path "$desktopPath\zapret_vayul") {
        Write-ColorMessage "Удаление существующей папки zapret_vayul с рабочего стола..." -color Magenta
        Remove-Item "$desktopPath\zapret_vayul" -Recurse -Force
    }
    if (Test-Path "$desktopPath\zapret") {
        $deleteChoice = Read-Host "Папка 'zapret' уже существует. Удалить ее? (Да/Нет)"
        if ($deleteChoice -eq 'Да') {
            Write-ColorMessage "Удаление старой папки zapret с рабочего стола..." -color Magenta
            Remove-Item "$desktopPath\zapret" -Recurse -Force
        }
    }
}

Write-ColorMessage "Скачивание ZIP файла..." -color Blue
try {
    Invoke-WebRequest -Uri $zipUrl -OutFile $zapretZipPath
    Write-ColorMessage "ZIP файл успешно скачан!" -color Green
} catch {
    Write-ColorMessage "Ошибка при скачивании файла!" -color Red
    exit 1
}

Write-ColorMessage "Распаковка архива..." -color Blue
try {
    Expand-Archive -Path $zapretZipPath -DestinationPath $destinationPath -Force
    Write-ColorMessage "Архив успешно распакован!" -color Green
    # Если распаковка на рабочий стол, переименовать папку в zapret_vayul
    if ($destinationPath -eq "$desktopPath\zapret") {
        Rename-Item -Path "$destinationPath" -NewName "zapret_vayul"
        Write-ColorMessage "Папка переименована в zapret_vayul" -color Cyan
    } else {
        Write-ColorMessage "Папка будет называться zapret" -color Cyan
    }
} catch {
    Write-ColorMessage "Ошибка при распаковке архива!" -color Red
    exit 1
}

Write-ColorMessage "Удаление ZIP файла..." -color Magenta
Remove-Item $zapretZipPath -Force

Write-ColorMessage "Открытие README..." -color Cyan
Start-Process "https://raw.githubusercontent.com/vayulqq/zapret/main/readme.txt"

Write-ColorMessage "Завершение скрипта..." -color Green
pause
