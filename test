Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
# Проверка безопасного режима
function Check-SafeMode {
    $safeModeKey = "HKLM\SYSTEM\CurrentControlSet\Control\SafeBoot\Option"
    try {
        if (Test-Path $safeModeKey) {
            $safeModeValue = Get-ItemProperty -Path $safeModeKey -Name Option -ErrorAction SilentlyContinue
            if ($safeModeValue.Option -eq 1) {
                return $true
            } else {
                return $false
            }
        } else {
            return $false
        }
    } catch {
        return $false
    }
}

# Проверка прав администратора
function Check-AdminRights {
    try {
        $currentUser = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
        return $currentUser.IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)
    } catch {
        return $false
    }
}

# Проверка режима
$safeMode = Check-SafeMode
$isAdmin = Check-AdminRights

if (-not $safeMode) {
    Write-Host "Скрипт должен быть запущен в безопасном режиме." -ForegroundColor Yellow
    Write-Host "Для включения безопасного режима выполните: msconfig и выберите безопасный режим с сетью."
    exit  # Завершение работы скрипта
}

if (-not $isAdmin) {
    Write-Host "Скрипт должен быть запущен с правами администратора." -ForegroundColor Yellow
    exit  # Завершение работы скрипта
}

Write-Host "Все проверки пройдены. Продолжаем выполнение..." -ForegroundColor Green

# Удаление автозагрузки, процессов, служб, задач и реестра
$
$processes = @("ddxdiag.exe", "SppExtFileObj.exe", "SteamUpdate.exe", "OriginPlayer.exe", "directxutil.exe", "winws.exe")
$foldersToCheck = @("C:\ProgramData\DirectX", "C:\Users\Public\Libraries\AMD", "C:\Users\Public\Libraries\directx")
$tempFoldersToClean = @($env:Temp, "C:\Windows\Temp")
$taskNames = @("ddxdiag", "SppExtFileObj", "SteamUpdate", "OriginPlayer", "directxutil", "winws")
$servicesToStop = @("ddxdiag", "SppExtFileObj", "SteamUpdate", "directxutil", "DrvSvc", "zapret", "zapret DPI bypass", "windivert")

# Удаление процессов
foreach ($process in $processes) {
    try {
        Stop-Process -Name $process -Force -ErrorAction SilentlyContinue
    } catch {}
}

# Удаление записей из автозагрузки (реестр и папки)
$registryPaths = @(
    "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run",
    "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
)
foreach ($path in $registryPaths) {
    foreach ($process in $processes) {
        try {
            Remove-ItemProperty -Path $path -Name $process -ErrorAction SilentlyContinue
        } catch {}
    }
}

$startupFolders = @(
    "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup",
    "$env:AppData\Microsoft\Windows\Start Menu\Programs\Startup"
)
foreach ($folder in $startupFolders) {
    if (Test-Path $folder) {
        Get-ChildItem -Path $folder -Force | Where-Object { $processes -contains $_.Name } | Remove-Item -Force -ErrorAction SilentlyContinue
    }
}

# Удаление автозагрузки из служб
foreach ($service in $servicesToStop) {
    try {
        sc.exe stop $service > $null 2>&1
        sc.exe delete $service > $null 2>&1
    } catch {}
}

# Удаление папок
foreach ($folder in $foldersToCheck) {
    if (Test-Path $folder) {
        try {
            Remove-Item -Path $folder -Recurse -Force -ErrorAction SilentlyContinue
        } catch {}
    }
}

# Очистка временных папок
foreach ($temp in $tempFoldersToClean) {
    if (Test-Path $temp) {
        try {
            Get-ChildItem -Path $temp -Recurse -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        } catch {}
    }
}

# Удаление задач из планировщика
foreach ($task in $taskNames) {
    try {
        schtasks.exe /Delete /TN $task /F > $null 2>&1
    } catch {}
}

# Удаление записей из реестра (общих ключей)
$malwareRegistryKeys = @(
    "HKLM:\Software\ddxdiag",
    "HKCU:\Software\SppExtFileObj",
    "HKLM:\Software\SteamUpdate",
    "HKCU:\Software\directxutil"
)
foreach ($key in $malwareRegistryKeys) {
    if (Test-Path $key) {
        Remove-Item -Path $key -Recurse -Force -ErrorAction SilentlyContinue
    }
}

# Удаление XML-файлов задач
$scheduledTasksPath = "C:\Windows\System32\Tasks"
foreach ($task in $taskNames) {
    $taskPath = Join-Path -Path $scheduledTasksPath -ChildPath $task
    if (Test-Path $taskPath) {
        Remove-Item -Path $taskPath -Recurse -Force -ErrorAction SilentlyContinue
    }
}

# Отключение безопасного режима
function Disable-SafeMode {
    try {
        bcdedit /deletevalue safeboot > $null 2>&1
        Write-Host "Безопасный режим отключен." -ForegroundColor Green
    } catch {
        Write-Host "Не удалось отключить безопасный режим. Проверьте права доступа." -ForegroundColor Red
    }
}
try {
    $basePath = "HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options"
    $subKeys = Get-ChildItem -Path $basePath | Where-Object { $_.PSIsContainer }

    foreach ($subKey in $subKeys) {
        $parameters = Get-ItemProperty -Path $subKey.PSPath -ErrorAction SilentlyContinue
        if ($parameters -and $parameters.PSObject.Properties.Name -contains "MinimumStackCommitInBytes") {
            Remove-ItemProperty -Path $subKey.PSPath -Name MinimumStackCommitInBytes -ErrorAction Stop
        }
    }
} catch {
    Write-Host "Произошла ошибка: $_" -ForegroundColor Red
}

Disable-SafeMode

# Ожидание и перезагрузка ПК
Start-Sleep -Seconds 10
Write-Host "Перезагрузка компьютера..." -ForegroundColor Green
shutdown.exe /r /t 0
