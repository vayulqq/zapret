# Запуск диспетчера задач
Start-Process -FilePath "taskmgr.exe"
Start-Sleep -Seconds 5

# Остановка процессов
$processes = @("ddxdiag.exe", "SppExtFileObj.exe", "SteamUpdate.exe", "OriginPlayer.exe", "directxutil.exe")
function Stop-Processes {
    param ([string[]]$ProcessNames)
    foreach ($process in $ProcessNames) {
        try {
            $proc = Get-Process -Name $process -ErrorAction SilentlyContinue
            if ($proc) {
                Stop-Process -Name $process -Force
                Write-Host "Процесс $process остановлен."
            } else {
                Write-Host "Процесс $process не найден или уже остановлен."
            }
        } catch {
            Write-Host "Ошибка при остановке процесса $process: $_"
        }
    }
}
Stop-Processes -ProcessNames $processes

# Удаление папок и файлов
$foldersToCheck = @("C:\ProgramData\DirectX")
$filesToCheckInPublic = @("C:\Users\Public\AMD", "C:\Users\Public\directx")
function Delete-Folders {
    param ([string[]]$Folders, [string[]]$Processes)
    foreach ($folder in $Folders) {
        if (Test-Path $folder) {
            try {
                Remove-Item -Path $folder -Recurse -Force -ErrorAction Stop
                Write-Host "Папка ${folder} успешно удалена."
            } catch {
                Write-Host "Не удалось удалить папку ${folder}: $_"
                Write-Host "Повторная остановка процессов, связанных с ${folder}."
                Stop-Processes -ProcessNames $Processes
            }
        } else {
            Write-Host "Папка ${folder} не существует."
        }
    }
}
function Delete-Files {
    param ([string[]]$Files, [string[]]$Processes)
    foreach ($file in $Files) {
        if (Test-Path $file) {
            try {
                Remove-Item -Path $file -Force -ErrorAction Stop
                Write-Host "Файл ${file} успешно удалён."
            } catch {
                Write-Host "Не удалось удалить файл ${file}: $_"
                Write-Host "Повторная остановка процессов, связанных с ${file}."
                Stop-Processes -ProcessNames $Processes
            }
        } else {
            Write-Host "Файл ${file} не существует."
        }
    }
}
Delete-Folders -Folders $foldersToCheck -Processes $processes
Delete-Files -Files $filesToCheckInPublic -Processes $processes

# Очистка TEMP
$tempPaths = @("$env:TEMP", "C:\Windows\Temp")
function Clear-TempFolders {
    param ([string[]]$Paths)
    foreach ($tempPath in $Paths) {
        if (Test-Path $tempPath) {
            try {
                Get-ChildItem -Path $tempPath -Recurse -Force -ErrorAction Stop | Remove-Item -Recurse -Force -ErrorAction Stop
                Write-Host "Папка ${tempPath} успешно очищена."
            } catch {
                Write-Host "Не удалось очистить папку ${tempPath}: $_"
            }
        } else {
            Write-Host "Папка ${tempPath} не найдена."
        }
    }
}
Clear-TempFolders -Paths $tempPaths

# Отключение автозагрузки
$taskNames = @("ddxdiag", "SppExtFileObj", "SteamUpdate", "OriginPlayer", "directxutil")
foreach ($task in $taskNames) {
    try {
        # Проверка существования задачи перед отключением
        $taskExists = schtasks.exe /Query /TN $task -ErrorAction SilentlyContinue
        if ($taskExists) {
            schtasks.exe /Change /TN $task /DISABLE | Out-Null
            Write-Host "Задача ${task} успешно отключена."
        } else {
            Write-Host "Задача ${task} не найдена."
        }
    } catch {
        Write-Host "Не удалось отключить задачу ${task}: $_"
    }
}

# Повторное удаление папок и файлов, если они не удалились с первого раза
Write-Host "Повторная попытка удаления папок и файлов..."
Delete-Folders -Folders $foldersToCheck -Processes $processes
Delete-Files -Files $filesToCheckInPublic -Processes $processes

# Очистка TEMP перед завершением
Write-Host "Повторная очистка TEMP перед перезагрузкой."
Clear-TempFolders -Paths $tempPaths

# Завершение работы
Write-Host "Диспетчер задач открыт, процессы остановлены, папка DirectX и файлы AMD и directx удалены, автозагрузка отключена, TEMP очищен."
Write-Host "Система будет перезагружена через 10 секунд..."
Start-Sleep -Seconds 10
Restart-Computer -Force
